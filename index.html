<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>2D Maze Game (Fixed)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  background: #0b0b14;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: monospace;
  color: white;
}

#ui {
  position: fixed;
  top: 10px;
  text-align: center;
  width: 100%;
  color: #00ffff;
}

canvas {
  background: ;#d415ba
  border: 4px solid #00ffff;
}
</style>
</head>

<body>

<div id="ui">
  Level: <span id="level">1</span> |
  Coins: <span id="coins">0</span>
</div>

<canvas id="game" width="500" height="500"></canvas>

<script>
/* ================= BASIC SETUP ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let level = 1;
let gridSize = 9;
let tileSize = canvas.width / gridSize;
let maze = [];
let coins = [];
let collected = 0;

/* ================= PLAYER ================= */
const player = { x: 0, y: 0 };

/* ================= MAZE GENERATION ================= */
function generateMaze() {
  maze = [];
  coins = [];
  collected = 0;

  const wallChance = Math.min(0.25 + level * 0.03, 0.45);

  for (let y = 0; y < gridSize; y++) {
    maze[y] = [];
    for (let x = 0; x < gridSize; x++) {
      maze[y][x] = Math.random() < wallChance ? 1 : 0;
    }
  }

  maze[0][0] = 0;

  player.x = 0;
  player.y = 0;

  spawnCoins();

  document.getElementById("coins").textContent = collected;
  document.getElementById("level").textContent = level;
}

/* ================= COIN SPAWN (FIXED) ================= */
function spawnCoins() {
  const coinCount = Math.min(3 + level, gridSize);
  const used = new Set();

  while (coins.length < coinCount) {
    const x = Math.floor(Math.random() * gridSize);
    const y = Math.floor(Math.random() * gridSize);

    const key = `${x},${y}`;

    if (
      maze[y][x] === 0 &&
      !(x === 0 && y === 0) &&
      !used.has(key)
    ) {
      coins.push({ x, y, taken: false });
      used.add(key);
    }
  }
}

/* ================= DRAW ================= */
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Maze
  for (let y = 0; y < gridSize; y++) {
    for (let x = 0; x < gridSize; x++) {
      if (maze[y][x] === 1) {
        ctx.fillStyle = "#8ce01d";
        ctx.fillRect(
          x * tileSize,
          y * tileSize,
          tileSize,
          tileSize
        );
      }
    }
  }

  // Coins
  coins.forEach(c => {
    if (!c.taken) {
      ctx.fillStyle = "#facc15";
      ctx.beginPath();
      ctx.arc(
        c.x * tileSize + tileSize / 2,
        c.y * tileSize + tileSize / 2,
        tileSize * 0.25,
        0,
        Math.PI * 2
      );
      ctx.fill();
    }
  });

  // Player
  ctx.fillStyle = "#22d3ee";
  ctx.fillRect(
    player.x * tileSize + tileSize * 0.2,
    player.y * tileSize + tileSize * 0.2,
    tileSize * 0.6,
    tileSize * 0.6
  );
}

/* ================= ONE-STEP MOVE ================= */
function move(dx, dy) {
  const nx = player.x + dx;
  const ny = player.y + dy;

  if (
    nx >= 0 &&
    ny >= 0 &&
    nx < gridSize &&
    ny < gridSize &&
    maze[ny][nx] === 0
  ) {
    player.x = nx;
    player.y = ny;
  }

  // Collect coins
  coins.forEach(c => {
    if (!c.taken && c.x === player.x && c.y === player.y) {
      c.taken = true;
      collected++;
      document.getElementById("coins").textContent = collected;
    }
  });

  // Next level
  if (coins.every(c => c.taken)) {
    level++;
    gridSize += 2;
    tileSize = canvas.width / gridSize;
    generateMaze();
  }

  draw();
}

/* ================= KEYBOARD ================= */
window.addEventListener("keydown", e => {
  const k = e.key.toLowerCase();
  if (k === "w") move(0, -1);
  if (k === "s") move(0, 1);
  if (k === "a") move(-1, 0);
  if (k === "d") move(1, 0);
});

/* ================= CLICK / TOUCH ================= */
canvas.addEventListener("click", e => {
  const rect = canvas.getBoundingClientRect();
  const cx = e.clientX - rect.left;
  const cy = e.clientY - rect.top;

  const dx = cx - (player.x * tileSize + tileSize / 2);
  const dy = cy - (player.y * tileSize + tileSize / 2);

  if (Math.abs(dx) > Math.abs(dy)) {
    move(dx > 0 ? 1 : -1, 0);
  } else {
    move(0, dy > 0 ? 1 : -1);
  }
});

/* ================= START ================= */
generateMaze();
draw();
</script>

</body>
</html>
