<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Gesture Particle Universe</title>
<style>
  body { margin: 0; overflow: hidden; background: black; }
  video { display: none; }
  #hint {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    color: #0ff;
    font-family: monospace;
    font-size: 12px;
    opacity: 0.7;
  }
</style>
</head>
<body>

<video id="video" autoplay playsinline></video>
<div id="hint">‚úã Open = Expand | ü§è Pinch = Change Shape | üëâ Move = Color</div>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.158/build/three.module.js";
import { Hands } from "https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js";
import { Camera } from "https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js";

/* ---------------- MOBILE DETECT ---------------- */
const isMobile = /Android|iPhone/i.test(navigator.userAgent);
const PARTICLES = isMobile ? 800 : 2200;

/* ---------------- THREE SETUP ---------------- */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(70, innerWidth / innerHeight, 0.1, 2000);
camera.position.z = 300;

const renderer = new THREE.WebGLRenderer({ antialias: true });
renderer.setSize(innerWidth, innerHeight);
renderer.setPixelRatio(devicePixelRatio);
document.body.appendChild(renderer.domElement);

/* ---------------- PARTICLES ---------------- */
const geometry = new THREE.BufferGeometry();
const positions = new Float32Array(PARTICLES * 3);
const target = new Float32Array(PARTICLES * 3);

geometry.setAttribute("position", new THREE.BufferAttribute(positions, 3));

const material = new THREE.PointsMaterial({
  size: 4,
  color: 0xffffff,
  transparent: true,
  opacity: 0.9
});

const points = new THREE.Points(geometry, material);
scene.add(points);

/* ---------------- SHAPES ---------------- */
function generateShape(type) {
  for (let i = 0; i < PARTICLES; i++) {
    let x = 0, y = 0, z = 0;

    if (type === "heart") {
      let t = Math.random() * Math.PI * 2;
      let r = 20 * (1 - Math.sin(t));
      x = r * Math.cos(t) * 4;
      y = r * Math.sin(t) * 4;
    }

    if (type === "flower") {
      let a = Math.random() * Math.PI * 2;
      let r = Math.sin(6 * a) * 50;
      x = r * Math.cos(a);
      y = r * Math.sin(a);
    }

    if (type === "saturn") {
      let a = Math.random() * Math.PI * 2;
      x = Math.cos(a) * 80;
      z = Math.sin(a) * 80;
    }

    if (type === "firework") {
      let r = Math.random() * 80;
      let t = Math.random() * Math.PI * 2;
      let p = Math.random() * Math.PI;
      x = r * Math.sin(p) * Math.cos(t);
      y = r * Math.sin(p) * Math.sin(t);
      z = r * Math.cos(p);
    }

    target[i * 3] = x;
    target[i * 3 + 1] = y;
    target[i * 3 + 2] = z;
  }
}

const shapes = ["heart", "flower", "saturn", "firework"];
let shapeIndex = 0;
generateShape(shapes[shapeIndex]);

/* ---------------- HAND TRACKING ---------------- */
const video = document.getElementById("video");

navigator.mediaDevices.getUserMedia({ video: true })
  .then(stream => video.srcObject = stream);

const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands: 1,
  modelComplexity: 0,
  minDetectionConfidence: 0.5,
  minTrackingConfidence: 0.5
});

let lastSwitch = 0;
let spread = 1;
let hue = 0;

hands.onResults(res => {
  if (!res.multiHandLandmarks.length) return;

  const h = res.multiHandLandmarks[0];
  const pinch = Math.hypot(h[4].x - h[8].x, h[4].y - h[8].y);

  if (pinch < 0.03 && Date.now() - lastSwitch > 1200) {
    shapeIndex = (shapeIndex + 1) % shapes.length;
    generateShape(shapes[shapeIndex]);
    lastSwitch = Date.now();
  }

  spread = 1 + Math.abs(h[5].x - h[17].x) * 5;
  hue += 0.01;
  material.color.setHSL(hue % 1, 1, 0.6);
});

const cam = new Camera(video, {
  onFrame: async () => await hands.send({ image: video })
});
cam.start();

/* ---------------- ANIMATION ---------------- */
function animate() {
  requestAnimationFrame(animate);

  const pos = geometry.attributes.position.array;
  for (let i = 0; i < pos.length; i++) {
    pos[i] += (target[i] - pos[i]) * 0.08;
  }

  points.rotation.y += 0.002;
  renderer.render(scene, camera);
}

animate();
</script>
</body>
  </html>
